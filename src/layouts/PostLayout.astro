---
import HeroImage from '../components/HeroImage.astro';
import Byline from '../components/Byline.tsx';
import RightRailRelated from '../components/RightRailRelated.astro';
import ShareBar from '../components/ShareBar.tsx';
import TableOfContents from '../components/TableOfContents.tsx';
import '../styles/tokens.css';
import '../styles/tailwind.css';
import type { PostEntry } from '../content/config';
import type { MarkdownHeading } from 'astro';
import { formatDate, formatReadingMinutes } from '../utils/format';
import { FEAR_CATEGORIES } from '../data/categories';

const {
  post,
  headings,
  readingTime,
  shareUrl,
  allPosts,
} = Astro.props as {
  post: PostEntry;
  headings: MarkdownHeading[];
  readingTime: number;
  shareUrl: string;
  allPosts: PostEntry[];
};

const { title, description, date, author, heroImage, heroImageAlt, fearCategories, fear_index_score, canonicalUrl } = post.data;
const displayDate = formatDate(date);
const readingTimeLabel = formatReadingMinutes(readingTime);
const isoDate = date.toISOString();
const heroAlt = heroImageAlt ?? `${title} hero image`;
const filteredHeadings = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const categoryByKey = new Map(FEAR_CATEGORIES.map((c) => [c.key, c]));
const primaryCategory = fearCategories?.[0] ? categoryByKey.get(fearCategories[0]) : undefined;
const categoryLabel = primaryCategory?.label;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  image: heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString(),
  datePublished: isoDate,
  dateModified: isoDate,
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'Survive the AI',
  },
  mainEntityOfPage: canonicalUrl,
};
---
<!DOCTYPE html>
<html lang="en" class="bg-white text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {description && <meta name="description" content={description} />}
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString()} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString()} />
    <title>{title} Â· Survive the AI</title>
    <script type="application/ld+json">{JSON.stringify(structuredData)}</script>
    <script is:inline>
      (function() {
        try {
          const stored = localStorage.getItem('theme');
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const useDark = stored ? stored === 'dark' : prefersDark;
          document.documentElement.classList.toggle('dark', useDark);
        } catch (e) {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          if (prefersDark) document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>
  <body class="bg-white text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100 antialiased">
    <div class="mx-auto max-w-[1200px] px-4 sm:px-6 lg:px-8">
      <div class="lg:grid lg:grid-cols-12 lg:gap-10">
        <main class="pb-16 space-y-6 sm:space-y-8 lg:col-span-8">
          <slot name="hero">
            <HeroImage src={heroImage} alt={heroAlt} />
          </slot>
          <header class="space-y-4">
            <div class="flex flex-wrap items-center gap-3 text-xs uppercase tracking-[0.3em] text-neutral-500">
              <span>{categoryLabel ?? 'Fear Index'}</span>
              <span aria-hidden class="hidden h-1 w-1 rounded-full bg-neutral-300 sm:block" />
              <span>Fear Index: {fear_index_score}</span>
            </div>
            <slot name="heading">
              <h1 class="text-3xl font-extrabold tracking-tight text-neutral-900 sm:text-4xl">{title}</h1>
              {description && <p class="text-base text-neutral-700 sm:text-lg">{description}</p>}
            </slot>
            <div class="lg:hidden">
              <slot name="share-bar-top">
                <ShareBar client:load url={shareUrl} title={title} className="mt-2" />
              </slot>
            </div>
          </header>
          <Byline
            client:idle
            author={author}
            displayDate={displayDate}
            isoDate={isoDate}
            readingTime={readingTimeLabel}
          />
          <slot name="inline-cta" />
          {filteredHeadings.length > 0 && (
            <div class="lg:hidden">
              <TableOfContents client:load headings={filteredHeadings} initiallyCollapsed={true} />
            </div>
          )}
          <article class="mx-auto w-full max-w-[760px] prose prose-neutral text-neutral-900 prose-headings:font-extrabold prose-a:underline-offset-2 dark:prose-invert dark:text-neutral-100">
            <slot />
          </article>
          <footer class="pt-6">
            <slot name="share-bar-bottom">
              <ShareBar client:load url={shareUrl} title={title} />
            </slot>
          </footer>
        </main>
        <aside class="space-y-8 lg:col-span-4">
          <div class="space-y-8 lg:sticky lg:top-24">
            <RightRailRelated currentSlug={post.slug} posts={allPosts} />
            {filteredHeadings.length > 0 && (
              <div class="hidden lg:block">
                <TableOfContents client:load headings={filteredHeadings} initiallyCollapsed={false} />
              </div>
            )}
          </div>
        </aside>
      </div>
    </div>
  </body>
</html>
