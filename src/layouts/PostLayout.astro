---
import Navbar from '../components/Navbar.astro';
import HeroImage from '../components/HeroImage.astro';
import Byline from '../components/Byline.tsx';
import RightRailRelated from '../components/RightRailRelated.astro';
import ShareBar from '../components/ShareBar.tsx';
import TableOfContents from '../components/TableOfContents.tsx';
import '../styles/tokens.css';
import '../styles/tailwind.css';
import type { PostEntry } from '../content/config';
import type { MarkdownHeading } from 'astro';
import { formatDate, formatReadingMinutes } from '../utils/format';
import { TOPIC_CATEGORIES } from '../data/categories';

const {
  post,
  headings,
  readingTime,
  shareUrl,
  allPosts,
} = Astro.props as {
  post: PostEntry;
  headings: MarkdownHeading[];
  readingTime: number;
  shareUrl: string;
  allPosts: PostEntry[];
};

const { title, description, date, author, heroImage, heroImageAlt, topics, impact_score, canonicalUrl } = post.data;
const displayDate = formatDate(date);
const readingTimeLabel = formatReadingMinutes(readingTime);
const isoDate = date.toISOString();
const heroAlt = heroImageAlt ?? `${title} hero image`;
const filteredHeadings = headings.filter((heading) => heading.depth === 2 || heading.depth === 3);
const tocHeadings = filteredHeadings.length >= 4 ? filteredHeadings : [];
const categoryByKey = new Map(TOPIC_CATEGORIES.map((c) => [c.key, c]));
const primaryCategory = topics?.[0] ? categoryByKey.get(topics[0]) : undefined;
const categoryLabel = primaryCategory?.label;

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  description,
  image: heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString(),
  datePublished: isoDate,
  dateModified: isoDate,
  author: {
    '@type': 'Person',
    name: author,
  },
  publisher: {
    '@type': 'Organization',
    name: 'Survive the AI',
  },
  mainEntityOfPage: canonicalUrl,
};
---
<!DOCTYPE html>
<html lang="en" class="bg-white text-neutral-900">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {description && <meta name="description" content={description} />}
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:type" content="article" />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString()} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={heroImage.startsWith('http') ? heroImage : new URL(heroImage, canonicalUrl).toString()} />
    <title>{title} Â· Survive the AI</title>
    <script type="application/ld+json">{JSON.stringify(structuredData)}</script>
  </head>
  <body class="bg-white text-neutral-900 antialiased">
    <Navbar />
    <div class="mx-auto max-w-[1200px] px-4 sm:px-6 lg:px-8 pb-16 pt-10 sm:pt-12">
      <div class="lg:grid lg:grid-cols-12 lg:gap-12">
        <main class="space-y-8 sm:space-y-10 lg:col-span-8">
          <slot name="hero">
            <HeroImage src={heroImage} alt={heroAlt} />
          </slot>
          <header class="space-y-5 sm:space-y-6">
            <div class="flex flex-wrap items-center gap-3 text-[11px] font-semibold uppercase tracking-[0.32em] text-neutral-500">
              <span>{categoryLabel ?? 'Key Topic'}</span>
              <span aria-hidden class="hidden h-1 w-1 rounded-full bg-neutral-300 sm:block" />
              <span>Impact Score: {impact_score}</span>
            </div>
            <slot name="heading">
              <h1 class="text-4xl font-black tracking-tight text-neutral-900 sm:text-5xl leading-[1.05]">{title}</h1>
              {description && (
                <p class="text-xl text-neutral-700 sm:text-2xl leading-relaxed">
                  {description}
                </p>
              )}
            </slot>
            <div class="lg:hidden">
              <slot name="share-bar-top">
                <ShareBar client:load url={shareUrl} title={title} className="mt-2" />
              </slot>
            </div>
          </header>
          <Byline
            client:idle
            author={author}
            displayDate={displayDate}
            isoDate={isoDate}
            readingTime={readingTimeLabel}
          />
          <slot name="inline-cta" />
          <article class="prose prose-lg text-neutral-900 prose-headings:font-black prose-h2:mt-12 prose-h2:pt-2 prose-h3:mt-8 prose-p:text-neutral-800 prose-li:text-neutral-800 prose-strong:text-neutral-900 prose-blockquote:border-l-4 prose-blockquote:border-neutral-900/30 prose-blockquote:bg-neutral-50 prose-blockquote:px-6 prose-blockquote:py-4 prose-blockquote:font-semibold prose-blockquote:text-neutral-800">
            <slot />
          </article>
          <footer class="pt-6">
            <slot name="share-bar-bottom">
              <ShareBar client:load url={shareUrl} title={title} />
            </slot>
          </footer>
        </main>
        <aside class="space-y-8 lg:col-span-4">
          <div class="space-y-8 lg:sticky lg:top-24">
            <RightRailRelated currentSlug={post.slug} posts={allPosts} />
            {tocHeadings.length > 0 && (
              <div class="hidden lg:block">
                <TableOfContents client:load headings={tocHeadings} initiallyCollapsed={false} />
              </div>
            )}
          </div>
        </aside>
      </div>
    </div>
  </body>
</html>
