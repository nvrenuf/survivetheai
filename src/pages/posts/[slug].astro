---
import { getCollection } from 'astro:content';
import PostLayout from '../../layouts/PostLayout.astro';
import { readingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, allPosts: posts },
  }));
}

const { post, allPosts } = Astro.props;
const { Content, headings } = await post.render();
const { minutes } = readingTime(post.body ?? '');
const shareUrl = post.data.canonicalUrl || new URL(`/posts/${post.slug}/`, Astro.site ?? 'https://survivetheai.com').toString();
const affiliate = post.data.affiliate_offer;
---
<PostLayout
  post={post}
  headings={headings}
  readingTime={minutes}
  shareUrl={shareUrl}
  allPosts={allPosts}
>
  {affiliate && (
    <div
      slot="inline-cta"
      class="space-y-4 rounded-3xl border border-neutral-800/80 bg-neutral-950/70 p-6 shadow-[0_10px_30px_-20px_rgba(0,0,0,0.8)]"
    >
      <div class="space-y-2">
        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-neutral-500">Featured offer</p>
        <h2 class="text-xl font-semibold text-neutral-100 sm:text-2xl">{affiliate.label}</h2>
        {affiliate.description && <p class="text-sm text-neutral-400 sm:text-base">{affiliate.description}</p>}
      </div>
      <div class="flex flex-col gap-3 sm:flex-row">
        <a
          href={affiliate.url}
          class="inline-flex items-center justify-center rounded-full bg-neutral-50 px-5 py-2 text-sm font-semibold text-neutral-900 transition hover:bg-neutral-200"
          target="_blank"
          rel="noopener noreferrer"
        >
          Access the offer
        </a>
        <a
          href={shareUrl}
          class="inline-flex items-center justify-center rounded-full border border-neutral-700/80 px-5 py-2 text-sm font-semibold text-neutral-200 transition hover:border-neutral-500 hover:text-neutral-50"
        >
          Share this playbook
        </a>
      </div>
    </div>
  )}
  <Content />
</PostLayout>
