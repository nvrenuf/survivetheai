---
import type { PostEntry } from '../content/config';
import { formatDate } from '../utils/format';
import { TOPIC_CATEGORIES } from '../data/categories';

const { currentSlug, posts } = Astro.props as {
  currentSlug: string;
  posts: PostEntry[];
};

const categoryByKey = new Map(TOPIC_CATEGORIES.map((c) => [c.key, c]));
const getPrimaryKey = (entry: PostEntry) => entry.data.topics?.[0];
const getPrimaryLabel = (entry: PostEntry) => {
  const key = getPrimaryKey(entry);
  return key ? categoryByKey.get(key)?.label : undefined;
};

const sortedPosts = [...posts].filter((entry) => entry.slug !== currentSlug);
sortedPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentPrimaryKey = posts.find((p) => p.slug === currentSlug)?.data.topics?.[0];
const relatedPool =
  currentPrimaryKey != null
    ? sortedPosts.filter((entry) => entry.data.topics?.includes(currentPrimaryKey))
    : sortedPosts;
const related = (relatedPool.length >= 3 ? relatedPool : sortedPosts).slice(0, 5);
---
<section class="space-y-4">
  <h2 class="text-xs font-semibold uppercase tracking-[0.3em] text-neutral-600">
    More in {currentPrimaryKey ? categoryByKey.get(currentPrimaryKey)?.label ?? 'Related' : 'Related'}
  </h2>
  <ul class="space-y-4">
    {related.map((entry) => {
      const heroImage = entry.data.heroImage;
      const dateLabel = formatDate(entry.data.date);
      const hasHero = typeof heroImage === 'string' && heroImage.trim().length > 0;

      return (
        <li>
          <a href={`/posts/${entry.slug}/`} class="group flex items-center gap-4 rounded-2xl border border-neutral-200 p-2 transition hover:border-neutral-300 hover:bg-neutral-50 dark:border-neutral-800 dark:hover:border-neutral-700 dark:hover:bg-neutral-800/60">
            <div class="relative h-14 w-14 overflow-hidden rounded-xl border border-neutral-200 bg-neutral-50 dark:border-neutral-800 dark:bg-neutral-800/70">
              {hasHero && (
                <img
                  src={heroImage}
                  alt={entry.data.title}
                  loading="lazy"
                  decoding="async"
                  width="56"
                  height="56"
                  class="h-full w-full object-cover"
                  onerror="this.style.display='none'; const placeholder = this.nextElementSibling; if (placeholder) placeholder.classList.remove('hidden');"
                />
              )}
              <div class={`absolute inset-0 flex items-center justify-center text-[10px] font-medium text-neutral-400 dark:text-neutral-500 ${hasHero ? 'hidden' : ''}`}>
                No image
              </div>
            </div>
            <div class="space-y-1">
              <p
                class="text-sm font-semibold text-neutral-900 transition group-hover:text-neutral-700 dark:text-neutral-50 dark:group-hover:text-neutral-200"
                style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"
              >
                {entry.data.title}
              </p>
              <p class="text-xs text-neutral-600 dark:text-neutral-400">{dateLabel}</p>
            </div>
          </a>
        </li>
      );
    })}
  </ul>
</section>
