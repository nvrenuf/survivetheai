---
import { TOPIC_CATEGORIES } from '../data/categories';

const links = [
  { href: '/', label: 'Home', testId: 'nav-home' },
  { href: '/posts', label: 'Survival Library', testId: 'nav-library' },
];

const survivalAreas = [...TOPIC_CATEGORIES].sort((a, b) => a.order - b.order);
---
<nav class="bg-neutral-950 text-neutral-50 shadow-sm" data-testid="navbar">
  <div class="mx-auto flex max-w-7xl items-center justify-between gap-4 px-4 py-4">
    <a href="/" class="flex items-center gap-2 text-2xl font-bold tracking-tight text-white transition hover:text-neutral-50" data-testid="nav-logo">
      Survive the AI
    </a>
    <div class="hidden items-center gap-2 md:flex">
      {links.map((link) => (
        <a
          href={link.href}
          class="rounded-full px-4 py-2 text-sm font-semibold uppercase tracking-[0.2em] text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
          data-testid={link.testId}
        >
          {link.label}
        </a>
      ))}
      <div class="relative" data-testid="survival-areas-desktop">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold uppercase tracking-[0.2em] text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="desktop-survival-areas"
          data-dropdown-trigger
          data-target="desktop-survival-areas"
        >
          Survival Areas
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path
              fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.17l3.71-3.94a.75.75 0 1 1 1.08 1.04l-4.25 4.5a.75.75 0 0 1-1.08 0l-4.25-4.5a.75.75 0 0 1 .02-1.06Z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
        <div
          id="desktop-survival-areas"
          role="menu"
          data-dropdown-menu
          data-open="false"
          class="absolute right-0 z-20 mt-3 hidden min-w-[240px] rounded-2xl bg-neutral-900/95 p-2 shadow-2xl ring-1 ring-white/15 backdrop-blur data-[open=true]:flex data-[open=true]:flex-col"
        >
          {survivalAreas.map((area) => (
            <a
              href={`/category/${area.key}/`}
              role="menuitem"
              class="rounded-xl px-4 py-3 text-sm font-semibold text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
              data-testid={`survival-area-${area.key}`}
            >
              {area.label}
            </a>
          ))}
        </div>
      </div>
    </div>
    <button
      type="button"
      class="inline-flex items-center justify-center rounded-full p-2 text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 md:hidden"
      aria-label="Toggle navigation menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
      data-menu-toggle
      data-testid="mobile-menu-toggle"
    >
      <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>
  <div id="mobile-menu" class="hidden border-t border-white/10 bg-neutral-900 md:hidden" data-testid="mobile-menu">
    <div class="mx-auto flex max-w-7xl flex-col gap-2 px-4 py-4">
      {links.map((link) => (
        <a
          href={link.href}
          class="rounded-xl px-4 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
          data-testid={`${link.testId}-mobile`}
        >
          {link.label}
        </a>
      ))}
      <div class="border-t border-white/10 pt-3" data-testid="survival-areas-mobile">
        <button
          type="button"
          class="flex w-full items-center justify-between rounded-xl px-4 py-3 text-sm font-semibold uppercase tracking-[0.2em] text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="mobile-survival-areas"
          data-dropdown-trigger
          data-target="mobile-survival-areas"
        >
          Survival Areas
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path
              fill-rule="evenodd"
              d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.17l3.71-3.94a.75.75 0 1 1 1.08 1.04l-4.25 4.5a.75.75 0 0 1-1.08 0l-4.25-4.5a.75.75 0 0 1 .02-1.06Z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
        <div
          id="mobile-survival-areas"
          role="menu"
          data-dropdown-menu
          data-open="false"
          class="mt-2 hidden flex-col gap-2 rounded-xl bg-neutral-900/60 p-2 ring-1 ring-white/10 data-[open=true]:flex"
        >
          {survivalAreas.map((area) => (
            <a
              href={`/category/${area.key}/`}
              role="menuitem"
              class="rounded-lg px-4 py-3 text-sm font-semibold text-neutral-100 transition hover:bg-white/10 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400"
              data-testid={`survival-area-${area.key}-mobile`}
            >
              {area.label}
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
</nav>
<script is:inline>
  const toggle = document.querySelector('[data-menu-toggle]');
  const mobileMenu = document.getElementById('mobile-menu');
  const dropdownTriggers = Array.from(document.querySelectorAll('[data-dropdown-trigger]'));

  const closeDropdown = (menu, trigger) => {
    if (!menu) return;
    menu.dataset.open = 'false';
    if (trigger) trigger.setAttribute('aria-expanded', 'false');
  };

  const closeAllDropdowns = (exceptMenu) => {
    dropdownTriggers.forEach((trigger) => {
      const targetId = trigger.getAttribute('data-target');
      const menu = targetId ? document.getElementById(targetId) : null;
      if (menu && menu !== exceptMenu) {
        closeDropdown(menu, trigger);
      }
    });
  };

  dropdownTriggers.forEach((trigger) => {
    const targetId = trigger.getAttribute('data-target');
    const menu = targetId ? document.getElementById(targetId) : null;
    if (!menu) return;

    trigger.addEventListener('click', (event) => {
      event.preventDefault();
      const isOpen = menu.dataset.open === 'true';
      closeAllDropdowns(isOpen ? null : menu);
      menu.dataset.open = (!isOpen).toString();
      trigger.setAttribute('aria-expanded', (!isOpen).toString());
      if (!isOpen) {
        const firstLink = menu.querySelector('a');
        if (firstLink) firstLink.focus();
      }
    });

    trigger.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        trigger.click();
      }
      if (event.key === 'Escape') {
        closeDropdown(menu, trigger);
        trigger.focus();
      }
    });

    menu.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeDropdown(menu, trigger);
        trigger.focus();
      }
    });
  });

  document.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const isInsideDropdown = dropdownTriggers.some((trigger) => {
      const targetId = trigger.getAttribute('data-target');
      const menu = targetId ? document.getElementById(targetId) : null;
      return (trigger && trigger.contains(target)) || (menu && menu.contains(target));
    });
    if (!isInsideDropdown) {
      closeAllDropdowns(null);
    }
  });

  if (toggle && mobileMenu) {
    toggle.addEventListener('click', () => {
      const isHidden = mobileMenu.classList.toggle('hidden');
      toggle.setAttribute('aria-expanded', (!isHidden).toString());
      if (isHidden) {
        closeAllDropdowns(null);
      }
    });
  }
</script>
