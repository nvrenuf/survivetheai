---
import { TOPIC_CATEGORIES } from '../data/categories';
import VersionSwitcher from './VersionSwitcher.astro';

const topicCategories = [...TOPIC_CATEGORIES].sort((a, b) => a.order - b.order);
const desktopLinks = [
  { label: 'Start Here', href: '/v2/start-here' },
  { label: 'Blog', href: '/v2/blog' },
  { label: 'Quiz', href: '/quiz' },
  { label: 'Drops', href: '/drops' },
  { label: 'Archives', href: '/v1' },
];
---

<nav class="sticky top-0 z-40 border-b border-neutral-200 bg-white/90 backdrop-blur relative">
  <div class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between py-4">
      <a href="/v2" class="text-xl font-black tracking-tight text-neutral-900">SurviveTheAI</a>

      <!-- Desktop navigation -->
      <div class="hidden items-center gap-3 lg:flex">
        {desktopLinks.map((link) => (
          <a
            href={link.href}
            class="tap-target h-12 rounded-full px-4 py-2 text-base font-semibold text-neutral-800 transition hover:bg-neutral-100 hover:text-neutral-900"
          >
            {link.label}
          </a>
        ))}

        <VersionSwitcher />

        <div class="relative group">
          <button
            type="button"
            class="tap-target h-12 gap-1 rounded-full px-4 py-2 text-base font-semibold text-neutral-800 transition hover:bg-neutral-100 hover:text-neutral-900"
          >
            Topics
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" class="h-4 w-4" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
            </svg>
          </button>
          <div
            class="invisible absolute right-0 top-full mt-3 w-80 rounded-2xl border border-neutral-200 bg-white p-3 shadow-2xl opacity-0 transition duration-150 group-hover:visible group-hover:opacity-100 group-focus-within:visible group-focus-within:opacity-100"
          >
            <div class="space-y-1">
              {topicCategories.map((category) => (
                <a
                  href={`/v2/categories/${category.slug}/`}
                  class="tap-target w-full items-start gap-3 rounded-xl px-3 py-2 text-base transition hover:bg-neutral-50"
                >
                  <span
                    class="mt-1 inline-flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold"
                    style={`background-color:${category.color}1a; color:${category.color};`}
                  >
                    {category.icon}
                  </span>
                  <span class="space-y-0.5">
                    <span class="block text-base font-semibold text-neutral-900">{category.label}</span>
                    {category.description && <span class="block text-sm text-neutral-600">{category.description}</span>}
                  </span>
                </a>
              ))}
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile trigger -->
      <button
        class="tap-target h-12 w-12 rounded-full border border-neutral-200 bg-white text-neutral-900 shadow-sm transition hover:border-neutral-300 hover:bg-neutral-50 lg:hidden"
        type="button"
        data-mobile-toggle
        aria-expanded="false"
        aria-controls="mobile-nav"
      >
        <span class="sr-only">Open navigation</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-6 w-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile slide-in -->
  <div
    id="mobile-nav"
    class="lg:hidden absolute inset-x-0 top-0 origin-top transform rounded-b-3xl border-b border-neutral-200 bg-white shadow-2xl transition-all duration-200 ease-out -translate-y-full opacity-0 pointer-events-none"
  >
    <div class="flex items-center justify-between px-4 py-4">
      <a href="/v2" class="text-lg font-black text-neutral-900">SurviveTheAI</a>
      <button
        type="button"
        class="tap-target h-12 w-12 rounded-full border border-neutral-200 bg-white text-neutral-900 shadow-sm transition hover:border-neutral-300 hover:bg-neutral-50"
        data-mobile-close
        aria-label="Close menu"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-6 w-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M6 18L18 6" />
        </svg>
      </button>
    </div>
    <div class="space-y-1 px-4 pb-4">
      {desktopLinks.map((link) => (
        <a
          href={link.href}
          class="tap-target w-full rounded-2xl px-4 py-3 text-base font-semibold text-neutral-900 transition hover:bg-neutral-50"
        >
          {link.label}
        </a>
      ))}

      <div class="pt-2">
        <VersionSwitcher />
      </div>

      <div class="rounded-2xl border border-neutral-200 bg-neutral-50 px-4 py-3">
        <button
          type="button"
          class="tap-target w-full items-center justify-between text-base font-semibold text-neutral-900"
          data-topics-toggle
          aria-expanded="false"
          aria-controls="mobile-topics"
        >
          <span>Topics</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" class="h-5 w-5" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 9l6 6 6-6" />
          </svg>
        </button>
        <div id="mobile-topics" class="mt-3 hidden space-y-2">
          {topicCategories.map((category) => (
            <a
              href={`/v2/categories/${category.slug}/`}
              class="tap-target w-full items-start gap-3 rounded-xl px-3 py-2 text-base font-semibold text-neutral-900 transition hover:bg-white"
            >
              <span
                class="mt-1 inline-flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold"
                style={`background-color:${category.color}1a; color:${category.color};`}
              >
                {category.icon}
              </span>
              <span class="space-y-0.5">
                <span class="block">{category.label}</span>
                {category.description && <span class="block text-sm font-medium text-neutral-600">{category.description}</span>}
              </span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </div>
  <div
    id="mobile-backdrop"
    class="lg:hidden fixed inset-0 bg-black/30 opacity-0 transition-opacity duration-200 pointer-events-none"
    aria-hidden="true"
  ></div>
</nav>

<script is:inline>
  (() => {
    const mobileToggle = document.querySelector('[data-mobile-toggle]');
    const mobileClose = document.querySelector('[data-mobile-close]');
    const panel = document.getElementById('mobile-nav');
    const backdrop = document.getElementById('mobile-backdrop');
    const topicsToggle = document.querySelector('[data-topics-toggle]');
    const topicsList = document.getElementById('mobile-topics');

    const setMenuOpen = (isOpen) => {
      if (!panel || !backdrop || !mobileToggle) return;
      mobileToggle.setAttribute('aria-expanded', String(isOpen));
      panel.classList.toggle('opacity-0', !isOpen);
      panel.classList.toggle('opacity-100', isOpen);
      panel.classList.toggle('-translate-y-full', !isOpen);
      panel.classList.toggle('translate-y-0', isOpen);
      panel.classList.toggle('pointer-events-none', !isOpen);
      backdrop.classList.toggle('opacity-0', !isOpen);
      backdrop.classList.toggle('pointer-events-none', !isOpen);
    };

    mobileToggle?.addEventListener('click', () => setMenuOpen(true));
    mobileClose?.addEventListener('click', () => setMenuOpen(false));
    backdrop?.addEventListener('click', () => setMenuOpen(false));

    topicsToggle?.addEventListener('click', () => {
      if (!topicsList || !topicsToggle) return;
      const expanded = topicsToggle.getAttribute('aria-expanded') === 'true';
      topicsToggle.setAttribute('aria-expanded', String(!expanded));
      topicsList.classList.toggle('hidden');
    });

    window.matchMedia('(min-width: 1024px)').addEventListener('change', (event) => {
      if (event.matches) setMenuOpen(false);
    });
  })();
</script>
