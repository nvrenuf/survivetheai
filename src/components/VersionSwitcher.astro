---
// VersionSwitcher renders a compact control for toggling between the live (v2) and archive (v1) experiences.
// The component defaults to a dropdown on mobile to save space and shows an inline pill on desktop.
const currentPath =
  Astro.url?.pathname ??
  (Astro.request?.url ? new URL(Astro.request.url).pathname : '');
const activeKey = currentPath.startsWith('/v1') ? 'v1' : 'v2';

const versions = [
  { key: 'v2', label: 'v2 ðŸ”¥', href: '/v2', description: 'Latest experience' },
  { key: 'v1', label: 'v1', href: '/v1', description: 'Archive view' },
];
---
<div class="relative flex items-center" data-testid="version-switcher">
  <div class="hidden items-center gap-2 rounded-full border border-neutral-200 bg-white p-1 shadow-sm lg:flex">
    {versions.map((version) => {
      const isActive = version.key === activeKey;
      return (
        <a
          href={version.href}
          class={`tap-target min-w-[88px] justify-center rounded-full px-4 py-2 text-base font-semibold ${
            isActive ? 'bg-neutral-900 text-white shadow-sm' : 'text-neutral-800 hover:bg-neutral-50'
          }`}
          aria-pressed={isActive}
        >
          <span class="flex items-center gap-2">
            <span>{version.label}</span>
            {version.key === 'v2' && <span class="rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Latest</span>}
          </span>
        </a>
      );
    })}
  </div>

  <div class="relative w-full max-w-[220px] lg:hidden">
    <button
      type="button"
      class="tap-target w-full justify-between rounded-2xl border border-neutral-200 bg-white px-4 py-3 text-base font-semibold text-neutral-900 shadow-sm"
      data-version-toggle
      aria-haspopup="true"
      aria-expanded="false"
      aria-controls="version-menu"
    >
      <span class="flex items-center gap-2">
        <span class="inline-flex h-8 min-w-[48px] items-center justify-center rounded-full bg-neutral-900 px-2 text-sm font-semibold text-white">{activeKey.toUpperCase()}</span>
        <span>Switch version</span>
      </span>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="m6 9 6 6 6-6" />
      </svg>
    </button>
    <div
      id="version-menu"
      data-version-menu
      class="absolute right-0 z-20 mt-2 w-full min-w-[180px] space-y-2 rounded-2xl border border-neutral-200 bg-white p-2 shadow-xl transition duration-150 ease-out opacity-0 pointer-events-none"
    >
      {versions.map((version) => {
        const isActive = version.key === activeKey;
        return (
          <a
            href={version.href}
            class={`tap-target w-full justify-between rounded-xl px-4 py-3 text-base font-semibold ${
              isActive ? 'bg-neutral-900 text-white shadow-sm' : 'text-neutral-800 hover:bg-neutral-50'
            }`}
            aria-pressed={isActive}
          >
            <span class="flex items-center gap-2">
              <span>{version.label}</span>
              {version.key === 'v2' && <span class="rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Latest</span>}
            </span>
            <span class="text-sm font-medium text-neutral-500">{version.description}</span>
          </a>
        );
      })}
    </div>
  </div>
</div>

<script is:inline>
  (() => {
    const toggle = document.querySelector('[data-version-toggle]');
    const menu = document.querySelector('[data-version-menu]');

    if (!toggle || !menu) return;

    const closeMenu = () => {
      menu.classList.add('opacity-0', 'pointer-events-none');
      toggle.setAttribute('aria-expanded', 'false');
    };

    const openMenu = () => {
      menu.classList.remove('opacity-0', 'pointer-events-none');
      toggle.setAttribute('aria-expanded', 'true');
    };

    const handleToggle = () => {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        closeMenu();
      } else {
        openMenu();
      }
    };

    toggle.addEventListener('click', handleToggle);

    document.addEventListener('click', (event) => {
      if (!menu.contains(event.target) && !toggle.contains(event.target)) {
        closeMenu();
      }
    });

    window.addEventListener('resize', closeMenu);
  })();
</script>
